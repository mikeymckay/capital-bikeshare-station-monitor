<!DOCTYPE html> 
<html> 
	<head> 
	<title>Capital Bikeshare</title> 
	<link rel='stylesheet' href='style.css' />
	<script type='text/javascript' src='jquery.min.js'></script>
	<script type='text/javascript' src='flot/jquery.flot.min.js'></script>
	<script type='text/javascript' src='sammy.min.js'></script>
	<script type='text/javascript' src='jquery.liveFilter.js'></script>
</head> 
<body>
<div id='index'>
  <h1>Capital Bikeshare Station Monitor</h1>
The Capital Bikeshare Station Monitor shows you the <b>history of bike availability for every station in DC</b>. This way you'll know better than to try and get a bike at 18th &amp; Columbia at 8:45 on a Monday morning. Maybe it will also encourage Capital Bikeshare to expand some stations...
  <h2>Select a station</h2>
  Filter by name: <input  type="text" class="filter" name="liveFilter" />
  <ul id="stationsList"></ul>
</div>
<div id='station'>
  <div id='station-name'></div>
  <div id="plot" style="width:600px;height:300px"></div>
  <a id='select' href='#/stations'>Select other station</a>
</div>
<div>
<small>
This project was inspired by <a href='http://tomtaylor.co.uk'>Tom Taylor</a>'s <a href='http://cyclehire.tomtaylor.co.uk/'>London Cycle Hire Explorer</a>. It uses <a href='http://couchone.com'>CouchOne</a>'s kick ass hosted <a href='http://couchdb.apache.org'>CouchDB</a> service, <a href='http://code.google.com/p/flot/'>Flot</a>'s javascript plotting sweetness, <a href='http://sammyjs.org'>Sammy.js</a> for righteous routing, and <a href='http://github.com'>Github</a> to fork you up with free open source code (<a href='http://github.com/mikeymckay/capital-bikeshare-station-monitor'>fork this project</a> and improve it please!).
</small>
</div>
</body>
<script>
  stationIndexCallback = function (data){
    stationsList = ""
    stations = {}
    var stationData = data.query.results.stations.station;
    for (i=0;i<stationData.length;i++){
      station = stationData[i];
      stations[station.id] = station;
      stationsList += "<li><a href='#/station/"+station.id+"'>"+station.name+"</a></li>";
    }
  }
</script>
<script type="text/javascript" src="http://query.yahooapis.com/v1/public/yql?q=select%20*%20from%20xml%20where%20url%3D'http%3A%2F%2Fwww.capitalbikeshare.com%2Fstations%2FbikeStations.xml'&format=json&diagnostics=true&callback=stationIndexCallback"></script>
<script type="text/javascript">
  plotStationCallback = function (data){
    var plotData = [];
    for(i=0;i<data.rows.length;i++){
      plotData.push(data.rows[i].value);
    }
    $.plot($("#plot"), [{label: "Number of bikes", data: plotData}], {
      xaxis: {
        mode: "time",
//        timeformat: "%d %H:%M",
        tickFormatter: function (val, axis){
          record_date = new Date(val);
          return ["Sun","Mon","Tue","Wed","Thu","Fri","Sat","Sun"][record_date.getDay()] + " " + record_date.getHours() + ":" + record_date.getMinutes();

        }
      },
      series: {
        lines: { show: false } ,
        points: { show: true, radius: 2},
        bars: { show: true }
      }
    });
  }

  function plotStation(stationId){
    url = "http://mikeymckay.couchone.com/capital-bikeshare/_design/stations/_view/nb_bikes_by_id?key=%22"+stationId+"%22";
    url = url + "&callback=plotStationCallback";
    $('body').append("<script src='" + url + "'/>");
  }

  $('#stationsList').liveFilter('basic');

  // Setup hash routing
  var app = Sammy('#index', function() {
    this.get('#/station/:id', function() {
      var id = this.params["id"]
      $('#station').show();
      $('#index').hide();
      $('#station-name').html(stations[id].name);
      $.plot($("#plot"), [],{});
      plotStation(id);
    });
    this.get('#/stations', function() {
      $('#station').hide();
      $('#index').show();
      $('#stationsList').html(stationsList);
    });
  });
  // start the routing
  app.run('#/stations');

</script>
</html>
